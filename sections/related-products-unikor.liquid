{% comment %} Related products in Unikor style. Uses section collection or product recommendations. {% endcomment %}
{% assign collection = section.settings.collection | default: product.collections.first %}
{% if collection == blank and section.settings.collection == blank %}
  {% assign collection = collections.all %}
{% endif %}
{% assign products_to_show = section.settings.products_to_show | default: 4 %}
{% assign products = collection.products | where: 'available', true %}
{% assign exclude_current = products | where_exp: 'p', 'p.id != product.id' %}
{% if exclude_current.size > 0 %}
  {% assign products = exclude_current %}
{% endif %}
{% assign products = products | limit: products_to_show %}

{% if section.settings.heading != blank and products.size > 0 %}
  <section class="related-products">
    <div class="page-width">
      <h2 class="related-products__heading">{{ section.settings.heading }}</h2>
      <div class="related-products__grid">
        {% for prod in products %}
          <div class="related-product-card">
            <a href="{{ prod.url }}" class="related-product-card__image">
              {% if prod.featured_media %}
                <img
                  src="{{ prod.featured_media | image_url: width: 600 }}"
                  alt="{{ prod.featured_media.alt | default: prod.title }}"
                  width="600"
                  height="{{ 600 | divided_by: prod.featured_media.aspect_ratio | round }}"
                  loading="lazy"
                >
              {% else %}
                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#9ca3af;">No image</div>
              {% endif %}
            </a>
            <div class="related-product-card__content">
              <h3 class="related-product-card__title"><a href="{{ prod.url }}">{{ prod.title }}</a></h3>
              <div class="related-product-card__price-wrap">
                <span class="related-product-card__price">{{ prod.price | money }}</span>
                {% if prod.compare_at_price > prod.price %}
                  <span style="text-decoration:line-through;color:#6b7280;font-size:0.9rem;">{{ prod.compare_at_price | money }}</span>
                  {% assign save_pct = prod.compare_at_price | minus: prod.price | times: 100 | divided_by: prod.compare_at_price %}
                  <span class="related-product-card__save">SAVE {{ save_pct }}%</span>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </section>
{% endif %}

{% schema %}
{
  "name": "Related products (Unikor)",
  "class": "section-related-products-unikor",
  "tag": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Check Out Our Wireless Version:"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection (optional)",
      "info": "Leave blank to use the product's first collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 1,
      "max": 8,
      "step": 1,
      "label": "Products to show",
      "default": 4
    }
  ]
}
{% endschema %}
